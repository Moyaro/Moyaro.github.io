[toc]

# 打印预处理
## 24个主要功能
预览：视角变换、视距缩放、其他预览设置、投影类型变换
模型3D变换：模型旋转、模型缩放、模型平移
模型管理（一次打印多个或只打印一部分）：添加模型、删除模型、复制模型、合并模型、拆分模型

|                    |     |
| :----------------- | :-- |
| 等比例视图          |  |
| 前后视图            |     |
| 左右视图            |     |
| 上下视图            |     |
| 手动缩放            |     |
| 缩放到适合打印机显示 |     |
| 缩放到适合打印体显示 |     |
| 是否显示三角形的边   |     |
| 是否显示三角形的面   |     |
| 是否显示打印ID      |     |
| 是否显示坐标指针     |     |
| 其他显示设置        |     |
| 平行投影            |     |
| 透视投影            |     |
| 模型旋转            |     |
| 模型旋转            |     |
| 模型手动平移        |     |
| 模型自动排列        |     |
| 模型自动排列        |     |
| 添加模型            |     |
| 删除模型            |     |
| 复制模型            |     |
| 合并模型            |     |
| 拆分模型            |     |
## 加载模型
### 实现模型文件加载的类
| 相关类名              | 功能                                                                             | 和其他类的关系                      | 功能原理                                        |     |
| :------------------- | :------------------------------------------------------------------------------- | :--------------------------------- | :--------------------------------------------- | :-- |
| PulseAnimation       | 缩放动画                                                                          | ModelAnimation的子类               | 通过实现父类中BeforeAction函数来为模型添加动画效果 |     |
| DropAnimation        | 实现物体下放动画                                                                   | ModelAnimation的子类（策略模式关系） | 通过实现父类中BeforeAction函数来为模型添加动画效果 |     |
| ModelAnimation 抽象类 | 每个模型可以组合多个该类以达到在显示时的多个动画效果？                                 |                                    |                                                |     |
| ThreeDmodel 抽象类    |                                                                                  |                                    |                                                |     |
| PrintModel           | 加载模型文件，实现模型处理逻辑（每个模型文件对应一个该类对象，还可以对模型进行组合和拆分） | ThreeDmodel的子类（策略模式关系）    |                                                |     |
| TopoModel            | 存放模型的几何信息，修复和分析模型，每个修复后的模型文件对应一个类对象                   |                                    |                                                |     |
| ThreeDView           | 管理多个模型文件中的模型                                                            |                                    |                                                |     |
| ThreeDControl        | 模型的三维显示                                                                     |                                    |                                                |     |

策略模式：实现了同一个接口
实现动画：随着时间的变化，不断的移动模型位置或改变模型的大小
与真实的模型文件交互：调用PrintModel类的Load函数开启模型文件的加载，根据文件名的后缀来区分STL、OBJ、3DS文件
### TopoModel相关的类（非全部）
|                     |                                |     |     |     |
| :------------------ | :----------------------------- | :-- | :-- | :-- |
| TopoModel           | 存放模型的几何信息，修复和分析模型 |     |     |     |
| TopoTriangleStotage | 三角形集合，管理所有的三角形      |     |     |     |
| TopoTriangle        | 保存模型的三角形(面)信息          |     |     |     |
| TopoEdge            | 保存模型的中边信息？             |     |     |     |
| TopoVertexStorage   | 顶点集合，管理所有的顶点          |     |     |     |
| TopoVertex          | 保存模型的顶点信息               |     |     |     |

3D模型构成：三维形式的顶点，边，面三种元素，常采用三角形网格描述
顶点边和面的关系：边=由两个相邻顶点之差得出，三角形=由它的三个顶点表示，顶点=由两条边的交点得出
### 加载STL格式的模型文件
* 打开STL文件
* 读取前80个字节
* 接着读取4个字节保存到一个整数facetN中
* 比较文件中的字节数是否等于84+50*facetN
* * 若相等，该文件是一个二进制格式的STL文件，利用C#的二进制读取流，即可读取法向量和顶点
* * 若不相等，该文件是一个ASCII格式的STL文件，借助字符串的函数定位法向量和顶点，以子串的方式读取出来，然后转换保存到相应的类型结构中
## 显示模型
### 实现模型显示的类
| 相关类名          | 功能                                                                            | 和其他类的关系                   | 功能原理                          | 附录                                   |
| :---------------- | :------------------------------------------------------------------------------ | :------------------------------ | :-------------------------------- | :------------------------------------ |
| OpenTK.GLControl  | 是OpenTK库中用于3D显示的OpenGL控制的控制                                           |                                 |                                   |                                       |
| RHOpenGL          | 是模型显示真正依赖的类                                                            | 继承并扩展了OpenTK.GLControl     |                                   |                                       |
| **ThreeDControl** | 模型的三维显示，实际上作为RHOpenGL及其他控件的容器？                                 | 继承自UserControl的用户自定义控件 |                                   |                                       |
| Coordinate        | 坐标，在模型显示时额外显示一个三维坐标，帮助用户观察模型的旋转变换                     |                                 |                                   |                                       |
| ThreeDCamera      | 相机，实现视角和视距的变化，封装了相机或称为视点的相关操作，辅助ThreeDControl的模型显示 |                                 |                                   | 视角的变化和视距的变化通过对相机的移动实现 |
| **ThreeDView**    | 管理模型                                                                         |                                 | 利用ThreeDControl控件对模型进行显示 |                                       |


### OpenGL绘制过程中的矩阵处理 左下角原点
| 流程        | 功能                                                                                                                          | 备住                                                                                                                     |
| :---------- | :--------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------- |
| 物体坐标     |                                                                                                                              |                                                                                                                         |
| 视图模型矩阵 | 确定空间中的每个顶点的坐标                                                                                                      | 由模型矩阵和视图矩阵组合而成，模型矩阵用于确定世界坐标系中的点经历变换后的新的位置，视图矩阵用于把世界坐标系中的点转换到观察者的空间中 |
| 投影矩阵     | 将这些坐标映射到二维的屏幕上                                                                                                    |                                                                                                                         |
| 透视除法     | 经过透视投影矩阵的变换，得到的第4维坐标是Z，这时需要用"透视除法"把这一维坐标变换为1，气候就可以把x、y坐标线性变换到二维空间，即进行视口变换 |                                                                                                                         |
| 视口变换     | 将坐标值转换为设备坐标系中的坐标值（包括匹配不同的显示器）                                                                          |                                                                                                                         |
| 窗口坐标     |                                                                                                                              |                                                                                                                         |
投影时的标准观察体是一个边长为2的立方体，其坐标取值范围为[-1,1]，变换时用到的矩阵就是投影矩阵
代码变换矩阵的顺序与上述顺序相反，但并不影响代码的正确性，因为矩阵相乘满足结合律?
模型的变换体现在GLControl的视图模型矩阵中？
通过GLControl的投影矩阵类型来选择是采用平行投影还是透视投影
![OpenGL中典型的渲染流程](_v_images/20200311145626064_21246.png =419x)
## 自动放置模型?
算法思想:当我们添加长方形时，会为下次添加的长方形提前选择“感兴趣”的位置。理想的情况下，长方形会按着这个顺序添加。而所谓感兴趣的地方指的就是当前添加的长方形的正下方和正右方，第一个长方形会放在了左上方，下一个长方形可能放在它的右面或下面，以此类推。而包含这些长方形的区域在必要的时候会扩大为原来的两倍。
算法:
1.添加长方形Rect，试着把它放到现存的空间中
    1.1如果可以找到一个侯选点作为Rect的放置点，试着把这个放置点尽量向左上方移
        动。
    1.2添加Rect的信息，把Rect正下点和正右点添加到侯选点集中。
2.如果现存的空间中找不到可添加的地方，扩展现存的空间
    2.1如果空间已经到达了最大极限，则不再扩展
    2.2修改空间中的一维，进行扩展。添加Rect，如果成功，结束。
    2.3同时修改空间的两维，进行扩展。添加Rect，如果成功，结束。否则保持扩展，转
        到2.1继续。
# 切片及G-Code编辑
## 9个主要功能
|                                      |     |
| :----------------------------------- | :-- |
| 切片软件管理                           |     |
| 切片参数设置                           |     |
| G-Code可视化显示单层                   |     |
| G-Code可视化显示一定范围的层            |     |
| G-Code可视化显示所有的层               |     |
| G-Code编辑，预处理和后处理脚本代码的编辑 |     |
| G-Code编辑，暂停和终止脚本的编辑        |     |
| G-Code编辑，常用功能脚本代码的编辑      |     |
| G-Code编辑，切片生成的代码的编辑        |     |
## 切片处理
主要任务就是管理这些切片软件及针对每个切片软件设置必要的切片参数。
### 实现切片处理相关的类
|             |                                                                                                                  |     |     |     |
| :---------- | :--------------------------------------------------------------------------------------------------------------- | :-- | :-- | :-- |
| Slic3rSetup | Slic3r管理，主要用于Slic3r软件多版本的管理和相关参数配置文件的管理                                                     |     |     |     |
| SlicerPanel | 切片管理界面，主要与用户进行交互                                                                                     |     |     |     |
| Slic3r      | 封装Slic3r，主要处理与Slic3r软件的交互                                                                              |     |     |     |
| Slicer      | 切片软件管理逻辑，主要用于背后逻辑的处理                                                                              |     |     |     |
| Skeinforge  | 封装并管理Skeinforge，利用SkeinConfig类进行切片参数的设置，它本身也负责与Skeinforge软件的交互及多版本Skeinforge软件的管理 |     |     |     |
| SkeinConfig | Skeinforge参数设置                                                                                                |     |     |     |
切片功能：利用Slic3r和Skeinforge软件实现
SlicerPanel类和Slicer类共同用于管理切片软件

### Slic3r和Skeinforge软件
OpenTK版本:1.1.0.0
Slic3r版本:1.0.0RC3
Skeinforge版本:12.03.14
Pypy版本:1.8.1-dev0 with MSC v.1500 32 bit
Python版本:2.7.2

Slic3r 第13页
Slic3r是一款用于将3D模型文件(STL, OBJ, AMF)转换成G-code的开源软件
Slic3r中重要的几何算法和数据结构使用C++编写，而GUI等高层模块则使用Perl开发。其中的C++ API是开放的，鼓励在其他项目中使用它们。
Slic3r可以运行在多个操作系统上，既可以用命令行的方式使用，也可以使用GUI界面进行操作。对于输出的G-code，也有多种不同的风格。
Skeinforge 第15页
Skeinforge也是一种开源的切片软件，它可以把3D模型文件(STL, GTS,OBJ, SVG, XML)转换为RepRap风格的G-code指令代码，遵循GPL开源协议，不过它是由一组Python脚本组成，所以为了运行Skeinforge还要安装Python。
Skeinforge可以设置很多的参数，这些参数按着逻辑分为很多组，图3.1是Skeinforge参数设置窗口，可以对Analyze, Craft, Help, Meta和Profile选项卡下的参数项进行相应的设置。其中经常需要修改的参数位于Craft选项卡下，这里可以设置打印的特性、设置温度参数、设置填充参数等很多与切片有关的参数。
### INI文件和注册表保存切片参数及其他参数
INI文件操作
* IniSection类对应于INI文件中的段落，它使用Dictionary数据结构来存储键值对？
* 接着IniFile类利用IniSection类来处理INI文件。
ps:注册表就是个除了数据库的优势以外全是屎的屎山
[YAML，JSON，ini，XML 用来做配置文件，优缺点分别是什么？](https://www.zhihu.com/question/41253282/answer/93720965)
## G-Code可视化及编辑
G-code是数控编程语言的一种统称，有时也称为G编程语言。主要用于计算机辅助设计中的机械自动化。
切片软件的管理使我们可以使用不同的切片软件进行分层切片，而为了得到满意的切片结果，我们就需要软件通过切片参数设置功能来设置一些参数，之后就可以进行切片得到G-code文件。
但为了能对切片的结果有一个直观的认识，所以就需要有G-code可视化功能对切片生成的结果进行预览，以观察切片结果是否达到了我们的打印要求。
另外，我们还可以利用G-code的编辑功能对生成的G-code直接进行修改或编写一些其他功能的G-code代码。
### G-code显示相关类图
| 相关类名         | 功能                                                                                                                                                               | 和其他类的关系                                     | 功能原理 |     |
| :-------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------- | :------ | :-- |
| ThreeDControl   | 预览分层                                                                                                                                                           |                                                  |         |     |
| ThreeDView      | 管理ThreeDModel                                                                                                                                                    |                                                  |         |     |
| ThreeDModel     | 抽象类                                                                                                                                                             |                                                  |         |     |
| GCodeVisual     | GCode可视化逻辑，管理一组切片得到的打印路径，每条路径由一组点集组成，同时包含打印路径间的移动数据                                                                           | ThreeDModel的子类，实现模型显示代码的复用（策略模式） |         |     |
| GCodePath       | 切片得到的轮廓线                                                                                                                                                    |                                                  |         |     |
| GCodePoint      | 轮廓线上的点                                                                                                                                                       |                                                  |         |     |
| GCodeAnalyzer   | GCode语法分析                                                                                                                                                      |                                                  |         |     |
| GCod            | 一种GCode存储格式，算是一种中规中举的存储格式，它可以转化为GCodeCompressed形式，也可以转换为GCodeShort的形式，还也可以以二进制格式或ASCII格式发送                             |                                                  |         |     |
| GCodeCompressed | GCode的压缩版，把打印任务以一种紧凑的方式存储在RAM中，它会把代码中的注释部分和代码前后的空格符去掉，以节省空间的使用量                                                        |                                                  |         |     |
| GcodeShort      | GCode简洁版，用成员flags的0-19bit表示layer,20-23bit表示tool, 24-29bit表示compressed command。其中的compressed command的作用是用一个整数值表示G-code中的命令关键字，见表4.4 |                                                  |         |     |
| GcodeTravel     | GCode中的移动                                                                                                                                                      |                                                  |         |     |

| 相关类名           | 功能              | 和其他类的关系 | 功能原理 |     |
| :----------------- | :---------------- | :----------- | :------ | :-- |
| Undo               | 撤销与重做         |              |         |     |
| GCodeShort         | 简洁版G-Code      |              |         |     |
| Content            | 代码内容           |              |         |     |
| RepetierEditor     | G-Code代码编辑器   |              |         |     |
| DoubleBufferPanel  | 双缓存panel       |              |         |     |
| GCodeAnalyzer      | G-Code语法分析     |              |         |     |
| Commands           | G-Code命令帮助说明 |              |         |     |
| CommandDescription | 命令描述           |              |         |     |
| CommandParameter   | 命令参数           |              |         |     |
在每次切片结束后，在Postprocess函数中会把生成的G-code文件自加载入RepetierEditor编辑器中，RepetierEditor采用了DoubleBufferPanel以缓解编辑器窗口的抖动，代码会被保存在Content类中，Content类则把代码保存在一组
GCodeShort中，同时Content利用Undo类帮助编辑器实现了撤销上一部和重做上一部的功能。另外Repetier Editor类还利用Commands类来对编辑器中的G-code代码给出一定的解释说明，以帮助用户了解代码的含义。
Postprocess函数》RepetierEditor类》Content类》GCodeShort

分层切片生成的G-code可以在Repetier-Host中进行预览，方式有三种:C1)选择“显示全部代码”，这样可以观察整体的分层情况。C2)选择“显示单层”，这样可以逐层观察分层的情况。C3)选择“显示指定的层”，这可以观察某一范围中的所有分层情况。如果在预览的过程中，还勾选上“显示材料”选项，那么还可以看到在每一层材料的打印路径。这时，如果我们在代码编辑器中选中了某一行或某几行代码，并且这些代码代表打印动作的话，那么相对应被打印的路径还会以高亮的方式显示。



41页的SimpleModel的类图对提取三维轮廓面有帮助 
